#!/bin/bash
# /home/sturt-wha-icket/scripts/install-monitoring-system-v2.sh
# Script de instalaci√≥n autom√°tica del sistema de monitoreo WATOOLX v2.0
# Autor: Asistente AI + Equipo de Desarrollo
# Fecha: 17 de Agosto 2025
# Versi√≥n: 2.0 (Reordenado con variables din√°micas)

# =============================================================================
# CONFIGURACI√ìN Y VARIABLES
# =============================================================================

# Cargar archivo de configuraci√≥n
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/watoolx-monitoring.conf"

# Verificar si existe el archivo de configuraci√≥n
if [ ! -f "$CONFIG_FILE" ]; then
    echo "‚ùå ERROR: Archivo de configuraci√≥n no encontrado: $CONFIG_FILE"
    echo "üí° Crea el archivo watoolx-monitoring.conf primero"
    exit 1
fi

# Cargar configuraci√≥n
source "$CONFIG_FILE"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# =============================================================================
# FUNCIONES DE UTILIDAD
# =============================================================================

# Funci√≥n de logging con colores
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case $level in
        "INFO") echo -e "${GREEN}[INFO]${NC} $timestamp - $message" | tee -a "$MAIN_LOG_FILE" ;;
        "WARN") echo -e "${YELLOW}[WARN]${NC} $timestamp - $message" | tee -a "$MAIN_LOG_FILE" ;;
        "ERROR") echo -e "${RED}[ERROR]${NC} $timestamp - $message" | tee -a "$MAIN_LOG_FILE" ;;
        "DEBUG") echo -e "${BLUE}[DEBUG]${NC} $timestamp - $message" | tee -a "$MAIN_LOG_FILE" ;;
    esac
}

# Funci√≥n de banner
show_banner() {
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë            INSTALADOR DEL SISTEMA DE MONITOREO               ‚ïë"
    echo "‚ïë                        WATOOLX v2.0                          ‚ïë"
    echo "‚ïë                    (Variables Din√°micas)                     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
}

# =============================================================================
# VERIFICACI√ìN DE REQUISITOS
# =============================================================================

check_requirements() {
    log_message "INFO" "üîç Verificando requisitos del sistema..."
    
    # Verificar si se ejecuta como root
    if [ "$EUID" -ne 0 ]; then
        log_message "ERROR" "‚ùå Este script debe ejecutarse como root"
        exit 1
    fi
    
    # Verificar directorio de scripts
    if [ ! -d "$SCRIPTS_DIR" ]; then
        log_message "ERROR" "‚ùå Directorio de scripts no encontrado: $SCRIPTS_DIR"
        exit 1
    fi
    
    # Verificar scripts necesarios
    for script in "${REQUIRED_SCRIPTS[@]}"; do
        if [ ! -f "$SCRIPTS_DIR/$script" ]; then
            log_message "ERROR" "‚ùå Script no encontrado: $script"
            exit 1
        fi
    done
    
    # Validar configuraci√≥n
    if ! validate_config; then
        log_message "ERROR" "‚ùå Configuraci√≥n inv√°lida"
        exit 1
    fi
    
    log_message "INFO" "‚úÖ Requisitos verificados correctamente"
}

# =============================================================================
# INSTALACI√ìN DE DEPENDENCIAS
# =============================================================================

install_dependencies() {
    log_message "INFO" "üì¶ Instalando dependencias del sistema..."
    
    # Actualizar repositorios
    apt-get update >/dev/null 2>&1
    
    # Instalar paquetes necesarios
    for package in "${SYSTEM_PACKAGES[@]}"; do
        if ! dpkg -l | grep -q "^ii  $package "; then
            log_message "INFO" "üì• Instalando $package..."
            apt-get install -y "$package" >/dev/null 2>&1
        else
            log_message "DEBUG" "‚ÑπÔ∏è $package ya est√° instalado"
        fi
    done
    
    log_message "INFO" "‚úÖ Dependencias instaladas correctamente"
}

# =============================================================================
# CONFIGURACI√ìN DE PERMISOS Y DIRECTORIOS
# =============================================================================

setup_permissions_and_directories() {
    log_message "INFO" "üîê Configurando permisos y directorios..."
    
    # Crear directorios necesarios
    for dir in "${REQUIRED_DIRECTORIES[@]}"; do
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir"
            log_message "DEBUG" "üìÇ Creado: $dir"
        fi
    done
    
    # Dar permisos de ejecuci√≥n a scripts
    chmod +x "$SCRIPTS_DIR"/*.sh
    
    # Configurar propiedad
    chown -R "$SERVICE_USER:$SERVICE_GROUP" "$SCRIPTS_DIR"
    chown -R "$SERVICE_USER:$SERVICE_GROUP" "$LOG_DIR"
    chown -R "$SERVICE_USER:$SERVICE_GROUP" "$BACKUP_DIR"
    
    log_message "INFO" "‚úÖ Permisos y directorios configurados correctamente"
}

# =============================================================================
# CONFIGURACI√ìN DE SERVICIOS SYSTEMD
# =============================================================================

setup_systemd_services() {
    log_message "INFO" "‚öôÔ∏è Configurando servicios systemd..."
    
    # Servicio de monitoreo de performance
    cat > /etc/systemd/system/watoolx-performance-monitor.service << EOF
[Unit]
Description=WATOOLX Performance Monitor
After=network.target

[Service]
Type=simple
User=$SERVICE_USER
Group=$SERVICE_GROUP
WorkingDirectory=$SCRIPTS_DIR
ExecStart=$SCRIPTS_DIR/monitor-performance.sh continuous
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    # Servicio de monitoreo MySQL + Disco
    cat > /etc/systemd/system/watoolx-mysql-monitor.service << EOF
[Unit]
Description=WATOOLX MySQL + Disk Monitor
After=mysql.service
Wants=mysql.service

[Service]
Type=simple
User=$SERVICE_USER
Group=$SERVICE_GROUP
WorkingDirectory=$SCRIPTS_DIR
ExecStart=$SCRIPTS_DIR/mysql-disk-monitor.sh monitor
Restart=always
RestartSec=30
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    # Servicio de mantenimiento diario
    cat > /etc/systemd/system/watoolx-daily-maintenance.service << EOF
[Unit]
Description=WATOOLX Daily Maintenance
After=network.target

[Service]
Type=oneshot
User=$SERVICE_USER
Group=$SERVICE_GROUP
WorkingDirectory=$SCRIPTS_DIR
ExecStart=$SCRIPTS_DIR/mysql-disk-monitor.sh maintenance
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

    # Timer para mantenimiento diario
    cat > /etc/systemd/system/watoolx-daily-maintenance.timer << EOF
[Unit]
Description=Run WATOOLX Daily Maintenance
Requires=watoolx-daily-maintenance.service

[Timer]
OnCalendar=*-*-* $WEEKLY_MAINTENANCE_HOUR:00:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # Recargar systemd
    systemctl daemon-reload
    
    log_message "INFO" "‚úÖ Servicios systemd configurados correctamente"
}

# =============================================================================
# CONFIGURACI√ìN DE CRON
# =============================================================================

setup_cron_jobs() {
    log_message "INFO" "‚è∞ Configurando tareas cron..."
    
    # Crear archivo cron personalizado
    cat > /etc/cron.d/watoolx-monitoring << EOF
# WATOOLX Monitoring System - Cron Jobs
# Limpieza de logs binarios MySQL (cada X horas)
0 */$MYSQL_CLEANUP_FREQUENCY * * * root $SCRIPTS_DIR/mysql-disk-monitor.sh cleanup >/dev/null 2>&1

# Reporte diario de estado (cada d√≠a a las X:00 AM)
0 $DAILY_REPORT_HOUR * * * root $SCRIPTS_DIR/mysql-disk-monitor.sh report >/dev/null 2>&1

# Verificaci√≥n de performance (cada X horas)
0 */$PERFORMANCE_CHECK_FREQUENCY * * * root $SCRIPTS_DIR/monitor-performance.sh once >/dev/null 2>&1

# Limpieza de logs antiguos (cada semana)
0 $WEEKLY_MAINTENANCE_HOUR * * $WEEKLY_MAINTENANCE_DAY root $SCRIPTS_DIR/mysql-disk-monitor.sh maintenance >/dev/null 2>&1

# Sistema de alertas WhatsApp cada X minutos
*/$ALERT_FREQUENCY * * * * root $SCRIPTS_DIR/send-whatsapp-alert.sh process >/dev/null 2>&1
EOF

    # Dar permisos al archivo cron
    chmod 644 /etc/cron.d/watoolx-monitoring
    
    log_message "INFO" "‚úÖ Tareas cron configuradas correctamente"
}

# =============================================================================
# CONFIGURACI√ìN DE LOGROTATE
# =============================================================================

setup_logrotate() {
    log_message "INFO" "üìù Configurando rotaci√≥n de logs..."
    
    # Configuraci√≥n para logs de WATOOLX
    cat > /etc/logrotate.d/watoolx << EOF
$LOG_DIR/watoolx-*.log {
    daily
    missingok
    rotate $LOG_ROTATION_DAYS
    compress
    delaycompress
    notifempty
    create 644 $SERVICE_USER $SERVICE_GROUP
    postrotate
        systemctl reload watoolx-performance-monitor >/dev/null 2>&1 || true
        systemctl reload watoolx-mysql-monitor >/dev/null 2>&1 || true
    endscript
}

/var/log/mysql/slow.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 mysql mysql
    postrotate
        systemctl reload mysql >/dev/null 2>&1 || true
    endscript
}
EOF

    log_message "INFO" "‚úÖ Rotaci√≥n de logs configurada correctamente"
}

# =============================================================================
# CONFIGURACI√ìN DE MYSQL OPTIMIZADA
# =============================================================================

setup_mysql_config() {
    log_message "INFO" "üê¨ Configurando MySQL optimizado para WATOOLX..."
    
    # Crear backup de configuraci√≥n actual
    local backup_file="$BACKUP_DIR/mysqld.cnf.backup.$(date +%Y%m%d_%H%M%S)"
    
    if [ -f "$MYSQL_CONFIG_FILE" ]; then
        cp "$MYSQL_CONFIG_FILE" "$backup_file"
        log_message "DEBUG" "üìã Backup creado: $backup_file"
    fi
    
    # Agregar configuraci√≥n optimizada si no existe
    if ! grep -q "WATOOLX" "$MYSQL_CONFIG_FILE"; then
        cat >> "$MYSQL_CONFIG_FILE" << EOF

# Configuraci√≥n optimizada para WATOOLX - $(date)
[mysqld]
# Configuraci√≥n de logs binarios (14 d√≠as)
expire_logs_days = $BINARY_LOG_RETENTION_DAYS
max_binlog_size = $MAX_BINLOG_SIZE
binlog_expire_logs_seconds = $BINARY_LOG_EXPIRE_SECONDS

# Configuraci√≥n de rendimiento
innodb_buffer_pool_size = $INNODB_BUFFER_POOL_SIZE
innodb_log_file_size = $INNODB_LOG_FILE_SIZE
innodb_log_buffer_size = $INNODB_LOG_BUFFER_SIZE

# Configuraci√≥n de seguridad
max_connections = $MAX_CONNECTIONS
wait_timeout = $WAIT_TIMEOUT
interactive_timeout = $INTERACTIVE_TIMEOUT

# Configuraci√≥n de logs
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_error = /var/log/mysql/error.log

# Configuraci√≥n de compresi√≥n
innodb_compression_pad_pct_max = 50
innodb_compression_level = 6
EOF
        log_message "INFO" "‚úÖ Configuraci√≥n de MySQL optimizada para 14 d√≠as"
    else
        log_message "DEBUG" "‚ÑπÔ∏è Configuraci√≥n de MySQL ya est√° optimizada"
    fi
}

# =============================================================================
# ACTIVACI√ìN DE SERVICIOS
# =============================================================================

enable_services() {
    log_message "INFO" "üöÄ Activando servicios del sistema..."
    
    local services=(
        "watoolx-performance-monitor"
        "watoolx-mysql-monitor"
        "watoolx-daily-maintenance.timer"
    )
    
    for service in "${services[@]}"; do
        systemctl enable "$service" >/dev/null 2>&1
        systemctl start "$service" >/dev/null 2>&1
        
        if systemctl is-active --quiet "$service"; then
            log_message "INFO" "‚úÖ $service activado y funcionando"
        else
            log_message "WARN" "‚ö†Ô∏è $service no se pudo activar correctamente"
        fi
    done
    
    log_message "INFO" "‚úÖ Servicios activados correctamente"
}

# =============================================================================
# VERIFICACI√ìN DE INSTALACI√ìN
# =============================================================================

verify_installation() {
    log_message "INFO" "üîç Verificando instalaci√≥n..."
    
    local checks=(
        "systemctl is-active watoolx-performance-monitor"
        "systemctl is-active watoolx-mysql-monitor"
        "systemctl is-enabled watoolx-daily-maintenance.timer"
        "test -f /etc/cron.d/watoolx-monitoring"
        "test -f /etc/logrotate.d/watoolx"
    )
    
    local passed=0
    local total=${#checks[@]}
    
    for check in "${checks[@]}"; do
        if eval "$check" >/dev/null 2>&1; then
            log_message "DEBUG" "‚úÖ Verificaci√≥n: $check"
            ((passed++))
        else
            log_message "WARN" "‚ö†Ô∏è Verificaci√≥n fall√≥: $check"
        fi
    done
    
    if [ $passed -eq $total ]; then
        log_message "INFO" "üéâ ¬°Instalaci√≥n completada exitosamente!"
        log_message "INFO" "‚úÖ $passed/$total verificaciones pasaron"
    else
        log_message "WARN" "‚ö†Ô∏è Instalaci√≥n completada con advertencias"
        log_message "WARN" "‚úÖ $passed/$total verificaciones pasaron"
    fi
}

# =============================================================================
# GENERACI√ìN DE REPORTE
# =============================================================================

generate_install_report() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local report_file="$BACKUP_DIR/install-report-$(date +%Y%m%d_%H%M%S).txt"
    
    cat > "$report_file" << EOF
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                REPORTE DE INSTALACI√ìN                        ‚ïë
‚ïë                    WATOOLX MONITORING v2.0                   ‚ïë
‚ïë                        $timestamp                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìã RESUMEN DE INSTALACI√ìN:
   Fecha: $timestamp
   Usuario: $SERVICE_USER
   Grupo: $SERVICE_GROUP
   Directorio: $SCRIPTS_DIR

üîß SERVICIOS INSTALADOS:
   - watoolx-performance-monitor.service
   - watoolx-mysql-monitor.service
   - watoolx-daily-maintenance.timer

‚è∞ TAREAS CRON CONFIGURADAS:
   - Limpieza MySQL: Cada $MYSQL_CLEANUP_FREQUENCY horas
   - Reporte diario: $DAILY_REPORT_HOUR:00 AM
   - Verificaci√≥n performance: Cada $PERFORMANCE_CHECK_FREQUENCY horas
   - Mantenimiento: D√≠a $WEEKLY_MAINTENANCE_DAY a las $WEEKLY_MAINTENANCE_HOUR:00
   - Alertas: Cada $ALERT_FREQUENCY minutos

üìÅ DIRECTORIOS CREADOS:
   - $LOG_DIR
   - $BACKUP_DIR
   - $CONFIG_DIR
   - $DATA_DIR

üìù ARCHIVOS DE CONFIGURACI√ìN:
   - /etc/systemd/system/watoolx-*.service
   - /etc/cron.d/watoolx-monitoring
   - /etc/logrotate.d/watoolx

üê¨ CONFIGURACI√ìN MYSQL:
   - Retenci√≥n logs binarios: $BINARY_LOG_RETENTION_DAYS d√≠as
   - Tama√±o m√°ximo binlog: $MAX_BINLOG_SIZE
   - Buffer pool InnoDB: $INNODB_BUFFER_POOL_SIZE
   - Log file InnoDB: $INNODB_LOG_FILE_SIZE

üöÄ COMANDOS √öTILES:
   - Ver estado: systemctl status watoolx-*
   - Ver logs: journalctl -u watoolx-*
   - Limpieza manual: $SCRIPTS_DIR/mysql-disk-monitor.sh cleanup
   - Reporte: $SCRIPTS_DIR/mysql-disk-monitor.sh report
   - Ver configuraci√≥n: $SCRIPTS_DIR/watoolx-monitoring.conf

‚úÖ INSTALACI√ìN COMPLETADA: $timestamp
EOF

    log_message "INFO" "üìã Reporte de instalaci√≥n generado: $report_file"
}

# =============================================================================
# FUNCI√ìN PRINCIPAL
# =============================================================================

main() {
    show_banner
    
    # Mostrar configuraci√≥n actual
    log_message "INFO" "‚öôÔ∏è Configuraci√≥n del sistema:"
    show_config
    
    log_message "INFO" "üöÄ Iniciando instalaci√≥n del sistema de monitoreo WATOOLX v2.0..."
    
    # Verificar requisitos
    check_requirements
    
    # Instalar dependencias
    install_dependencies
    
    # Configurar permisos y directorios
    setup_permissions_and_directories
    
    # Configurar servicios systemd
    setup_systemd_services
    
    # Configurar cron
    setup_cron_jobs
    
    # Configurar logrotate
    setup_logrotate
    
    # Configurar MySQL
    setup_mysql_config
    
    # Activar servicios
    enable_services
    
    # Verificar instalaci√≥n
    verify_installation
    
    # Generar reporte
    generate_install_report
    
    log_message "INFO" "üéâ ¬°Instalaci√≥n completada exitosamente!"
    log_message "INFO" "üìñ Revisa el reporte de instalaci√≥n para m√°s detalles"
    log_message "INFO" "üöÄ El sistema de monitoreo est√° funcionando autom√°ticamente"
    log_message "INFO" "‚öôÔ∏è Configuraci√≥n personalizable en: $CONFIG_FILE"
}

# Ejecutar funci√≥n principal
main "$@"
