#!/bin/bash
# /home/sturt-wha-icket/scripts/watoolx-monitoring.conf
# Archivo de configuración para el sistema de monitoreo WATOOLX
# Autor: Asistente AI + Equipo de Desarrollo
# Fecha: 17 de Agosto 2025
# Versión: 2.0

# =============================================================================
# CONFIGURACIÓN DEL SISTEMA
# =============================================================================

# Directorio principal del proyecto
WATOOLX_HOME="${WATOOLX_HOME:-/home/sturt-wha-icket}"

# Directorio de scripts
SCRIPTS_DIR="${SCRIPTS_DIR:-$WATOOLX_HOME/scripts}"

# Directorio de backups
BACKUP_DIR="${BACKUP_DIR:-$WATOOLX_HOME/backups/mysql}"

# Directorio de logs
LOG_DIR="${LOG_DIR:-/var/log/watoolx}"

# Directorio de configuración
CONFIG_DIR="${CONFIG_DIR:-/etc/watoolx}"

# Directorio de datos
DATA_DIR="${DATA_DIR:-/var/lib/watoolx}"

# =============================================================================
# CONFIGURACIÓN DE USUARIOS Y PERMISOS
# =============================================================================

# Usuario del servicio
SERVICE_USER="${SERVICE_USER:-root}"

# Grupo del servicio
SERVICE_GROUP="${SERVICE_GROUP:-root}"

# =============================================================================
# CONFIGURACIÓN DE MYSQL
# =============================================================================

# Usuario MySQL
MYSQL_USER="${MYSQL_USER:-root}"

# Contraseña MySQL
MYSQL_PASSWORD="${MYSQL_PASSWORD:-mysql1122}"

# Base de datos
MYSQL_DATABASE="${MYSQL_DATABASE:-watoolx}"

# Archivo de configuración MySQL
MYSQL_CONFIG_FILE="${MYSQL_CONFIG_FILE:-/etc/mysql/mysql.conf.d/mysqld.cnf}"

# =============================================================================
# CONFIGURACIÓN DE LOGS BINARIOS MYSQL
# =============================================================================

# Retención de logs binarios (en días)
BINARY_LOG_RETENTION_DAYS="${BINARY_LOG_RETENTION_DAYS:-14}"

# Tamaño máximo de logs binarios
MAX_BINLOG_SIZE="${MAX_BINLOG_SIZE:-100M}"

# Tiempo de expiración en segundos (14 días = 1,209,600 segundos)
BINARY_LOG_EXPIRE_SECONDS="${BINARY_LOG_EXPIRE_SECONDS:-1209600}"

# =============================================================================
# CONFIGURACIÓN DE PERFORMANCE MYSQL
# =============================================================================

# Tamaño del buffer pool InnoDB
INNODB_BUFFER_POOL_SIZE="${INNODB_BUFFER_POOL_SIZE:-1G}"

# Tamaño del archivo de log InnoDB
INNODB_LOG_FILE_SIZE="${INNODB_LOG_FILE_SIZE:-256M}"

# Tamaño del buffer de log InnoDB
INNODB_LOG_BUFFER_SIZE="${INNODB_LOG_BUFFER_SIZE:-64M}"

# Máximo de conexiones
MAX_CONNECTIONS="${MAX_CONNECTIONS:-200}"

# Timeout de conexiones
WAIT_TIMEOUT="${WAIT_TIMEOUT:-600}"

# Timeout interactivo
INTERACTIVE_TIMEOUT="${INTERACTIVE_TIMEOUT:-600}"

# =============================================================================
# CONFIGURACIÓN DE MONITOREO
# =============================================================================

# Umbral de CPU (%)
THRESHOLD_CPU="${THRESHOLD_CPU:-80}"

# Umbral de memoria (%)
THRESHOLD_MEMORY="${THRESHOLD_MEMORY:-85}"

# Umbral de carga del sistema
THRESHOLD_LOAD="${THRESHOLD_LOAD:-2.0}"

# Umbral de disco (%)
THRESHOLD_DISK="${THRESHOLD_DISK:-80}"

# Umbral de tamaño MySQL (GB)
THRESHOLD_MYSQL_SIZE="${THRESHOLD_MYSQL_SIZE:-50}"

# =============================================================================
# CONFIGURACIÓN DE CRON Y TIMERS
# =============================================================================

# Frecuencia de limpieza MySQL (cada X horas)
MYSQL_CLEANUP_FREQUENCY="${MYSQL_CLEANUP_FREQUENCY:-6}"

# Hora del reporte diario (formato 24h)
DAILY_REPORT_HOUR="${DAILY_REPORT_HOUR:-6}"

# Hora del mantenimiento semanal (formato 24h)
WEEKLY_MAINTENANCE_HOUR="${WEEKLY_MAINTENANCE_HOUR:-3}"

# Día de la semana para mantenimiento (0=Domingo, 1=Lunes, etc.)
WEEKLY_MAINTENANCE_DAY="${WEEKLY_MAINTENANCE_DAY:-0}"

# Frecuencia de verificación de performance (cada X horas)
PERFORMANCE_CHECK_FREQUENCY="${PERFORMANCE_CHECK_FREQUENCY:-1}"

# Frecuencia de alertas (cada X minutos)
ALERT_FREQUENCY="${ALERT_FREQUENCY:-5}"

# =============================================================================
# CONFIGURACIÓN DE ALERTAS
# =============================================================================

# Email para alertas
ALERT_EMAIL="${ALERT_EMAIL:-leowin8@gmail.com}"

# Número de WhatsApp para alertas
ADMIN_WHATSAPP_NUMBER="${ADMIN_WHATSAPP_NUMBER:-51959858768}"

# API endpoint para WhatsApp
WHATSAPP_API_ENDPOINT="${WHATSAPP_API_ENDPOINT:-https://waapi.powerwapp.net/api/messages/send}"

# Archivo de token WhatsApp
WHATSAPP_TOKEN_FILE="${WHATSAPP_TOKEN_FILE:-$WATOOLX_HOME/.whatsapp-token}"

# =============================================================================
# CONFIGURACIÓN DE LOGS
# =============================================================================

# Archivo de log principal
MAIN_LOG_FILE="${MAIN_LOG_FILE:-$LOG_DIR/watoolx-monitoring.log}"

# Archivo de log de performance
PERFORMANCE_LOG_FILE="${PERFORMANCE_LOG_FILE:-$LOG_DIR/watoolx-performance.log}"

# Archivo de log de MySQL
MYSQL_LOG_FILE="${MYSQL_LOG_FILE:-$LOG_DIR/watoolx-mysql.log}"

# Archivo de log de alertas
ALERT_LOG_FILE="${ALERT_LOG_FILE:-$LOG_DIR/watoolx-alerts.log}"

# Rotación de logs (días)
LOG_ROTATION_DAYS="${LOG_ROTATION_DAYS:-30}"

# =============================================================================
# CONFIGURACIÓN DE DEPENDENCIAS
# =============================================================================

# Paquetes del sistema a instalar
SYSTEM_PACKAGES=(
    "htop"
    "iotop" 
    "nethogs"
    "logwatch"
    "fail2ban"
    "mysql-client"
)

# Scripts requeridos
REQUIRED_SCRIPTS=(
    "monitor-performance.sh"
    "mysql-disk-monitor.sh"
    "send-whatsapp-alert.sh"
    "send-email-alert-v2.sh"
)

# =============================================================================
# CONFIGURACIÓN DE DIRECTORIOS
# =============================================================================

# Directorios a crear
REQUIRED_DIRECTORIES=(
    "$LOG_DIR"
    "$BACKUP_DIR"
    "$CONFIG_DIR"
    "$DATA_DIR"
)

# =============================================================================
# CONFIGURACIÓN DE SERVICIOS
# =============================================================================

# Servicios a crear
SYSTEMD_SERVICES=(
    "watoolx-performance-monitor"
    "watoolx-mysql-monitor"
    "watoolx-daily-maintenance"
)

# =============================================================================
# CONFIGURACIÓN DE ARCHIVOS
# =============================================================================

# Archivos de configuración del sistema
SYSTEM_CONFIG_FILES=(
    "/etc/systemd/system/watoolx-performance-monitor.service"
    "/etc/systemd/system/watoolx-mysql-monitor.service"
    "/etc/systemd/system/watoolx-daily-maintenance.service"
    "/etc/systemd/system/watoolx-daily-maintenance.timer"
    "/etc/cron.d/watoolx-monitoring"
    "/etc/logrotate.d/watoolx"
)

# =============================================================================
# FUNCIONES DE UTILIDAD
# =============================================================================

# Función para cargar configuración desde archivo
load_config() {
    if [ -f "$1" ]; then
        source "$1"
        return 0
    fi
    return 1
}

# Función para validar configuración
validate_config() {
    local errors=0
    
    # Verificar directorios críticos
    for dir in "$WATOOLX_HOME" "$SCRIPTS_DIR"; do
        if [ ! -d "$dir" ]; then
            echo "ERROR: Directorio no encontrado: $dir" >&2
            ((errors++))
        fi
    done
    
    # Verificar credenciales MySQL
    if [ -z "$MYSQL_USER" ] || [ -z "$MYSQL_PASSWORD" ]; then
        echo "ERROR: Credenciales MySQL no configuradas" >&2
        ((errors++))
    fi
    
    return $errors
}

# Función para mostrar configuración
show_config() {
    echo "=== CONFIGURACIÓN DEL SISTEMA DE MONITOREO WATOOLX ==="
    echo "Directorio principal: $WATOOLX_HOME"
    echo "Directorio de scripts: $SCRIPTS_DIR"
    echo "Directorio de backups: $BACKUP_DIR"
    echo "Usuario del servicio: $SERVICE_USER"
    echo "Retención logs binarios: $BINARY_LOG_RETENTION_DAYS días"
    echo "Frecuencia limpieza MySQL: cada $MYSQL_CLEANUP_FREQUENCY horas"
    echo "Email de alertas: $ALERT_EMAIL"
    echo "WhatsApp admin: $ADMIN_WHATSAPP_NUMBER"
    echo "=================================================="
}
