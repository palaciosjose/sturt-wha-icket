{"ast":null,"code":"import React,{useState,useEffect,useContext,useCallback}from\"react\";import{makeStyles}from\"@material-ui/core/styles\";import api from\"../../services/api\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{toast}from\"react-toastify\";import{useHistory}from'react-router-dom';import KanbanBoard from\"../../components/KanbanBoard\";import logger from\"../../utils/logger\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",alignItems:\"center\",padding:theme.spacing(1),height:\"100%\"},button:{background:\"#10a110\",border:\"none\",padding:\"10px\",color:\"white\",fontWeight:\"bold\",borderRadius:\"5px\"}}));const Kanban=()=>{const classes=useStyles();const history=useHistory();const[tags,setTags]=useState([]);const[tickets,setTickets]=useState([]);const[isLoading,setIsLoading]=useState(false);const{user}=useContext(AuthContext);const jsonString=user.queues.map(queue=>queue.UserQueue.queueId);const fetchTags=useCallback(async function(){let retryCount=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;if(isLoading)return;// Evitar requests mÃºltiples\ntry{setIsLoading(true);logger.dashboard.debug(\"ğŸ”„ Cargando tags de Kanban...\");const response=await api.get(\"/tags/kanban\");const fetchedTags=response.data.lista||[];setTags(fetchedTags);logger.dashboard.debug(\"âœ… Tags cargados:\",fetchedTags.length);// Fetch tickets after fetching tags\nawait fetchTickets(jsonString);}catch(error){var _error$message;// âœ… MANEJO SILENCIOSO DE ERRORES DE AUTENTICACIÃ“N\nif(error.response&&(error.response.status===401||error.response.status===403)){logger.dashboard.debug(\"ğŸ”„ Error de autenticaciÃ³n silenciado:\",error.response.status);// No mostrar error en consola para evitar spam\nreturn;}// Solo mostrar errores que no sean de autenticaciÃ³n\nlogger.dashboard.error(\"âŒ Error cargando tags:\",error);// Retry con backoff exponencial para errores de red\nif(retryCount<3&&(error.code==='ERR_INSUFFICIENT_RESOURCES'||((_error$message=error.message)===null||_error$message===void 0?void 0:_error$message.includes('ERR_INSUFFICIENT_RESOURCES')))){const delay=Math.pow(2,retryCount)*1000;// 1s, 2s, 4s\nlogger.dashboard.warn(`ğŸ”„ Reintentando en ${delay}ms (intento ${retryCount+1}/3)`);setTimeout(()=>{fetchTags(retryCount+1);},delay);return;}// Continuar sin tags si hay error despuÃ©s de retries\nlogger.dashboard.warn(\"âš ï¸ Continuando sin tags despuÃ©s de errores\");await fetchTickets(jsonString);}finally{setIsLoading(false);}},[jsonString,isLoading]);useEffect(()=>{// Agregar delay para evitar requests simultÃ¡neos\nconst timer=setTimeout(()=>{fetchTags();},1000);return()=>clearTimeout(timer);},[fetchTags]);const fetchTickets=async jsonString=>{try{var _data$tickets;logger.dashboard.debug(\"ğŸ”„ Cargando tickets de Kanban...\");const{data}=await api.get(\"/ticket/kanban\",{params:{queueIds:JSON.stringify(jsonString),teste:true}});setTickets(data.tickets);logger.dashboard.debug(\"âœ… Tickets cargados:\",((_data$tickets=data.tickets)===null||_data$tickets===void 0?void 0:_data$tickets.length)||0);}catch(err){logger.dashboard.error(\"âŒ Error cargando tickets:\",err);// Si es error de autenticaciÃ³n, no hacer nada (ya manejado por interceptor)\nif(err.response&&(err.response.status===401||err.response.status===403)){logger.dashboard.warn(\"ğŸ”„ Error de autenticaciÃ³n, manejado por interceptor\");return;}setTickets([]);}};const handleCardMove=async(cardId,sourceLaneId,targetLaneId)=>{try{logger.dashboard.debug(\"ğŸ”„ Moviendo ticket:\",{cardId,sourceLaneId,targetLaneId});// âœ… MANEJAR CASO ESPECIAL: ABIERTOS (sin etiquetas)\nif(targetLaneId==='abiertos'){// Solo eliminar etiquetas existentes para mover a ABIERTOS\nif(sourceLaneId&&sourceLaneId!==targetLaneId){try{const sourceTag=tags.find(tag=>{if(sourceLaneId==='atencion')return tag.name==='AtenciÃ³n';if(sourceLaneId==='cerrado')return tag.name==='Cerrado';return false;});if(sourceTag){await api.delete(`/ticket-tags/${cardId}`);logger.dashboard.debug(\"âœ… Etiqueta eliminada para mover a ABIERTOS\");}}catch(deleteErr){var _deleteErr$response;logger.dashboard.debug(\"â„¹ï¸ Etiqueta no existÃ­a en origen:\",(_deleteErr$response=deleteErr.response)===null||_deleteErr$response===void 0?void 0:_deleteErr$response.status);}}toast.success('Ticket movido a ABIERTOS exitosamente!');logger.dashboard.debug(\"âœ… Ticket movido a ABIERTOS\");// Recargar datos despuÃ©s del movimiento\nsetTimeout(()=>{fetchTags();},500);return;}// âœ… MANEJAR ETIQUETAS NORMALES (ATENCIÃ“N, CERRADO)\nconst targetTag=tags.find(tag=>{if(targetLaneId==='atencion')return tag.name==='AtenciÃ³n';if(targetLaneId==='cerrado')return tag.name==='Cerrado';return false;});if(!targetTag){logger.dashboard.error(\"âŒ Tag no encontrado para:\",targetLaneId);toast.error('Error: Tag no encontrado');return;}// Solo eliminar el tag si existe en el origen\nif(sourceLaneId&&sourceLaneId!==targetLaneId){try{// Encontrar el tag del origen\nconst sourceTag=tags.find(tag=>{if(sourceLaneId==='atencion')return tag.name==='AtenciÃ³n';if(sourceLaneId==='cerrado')return tag.name==='Cerrado';return false;});if(sourceTag){await api.delete(`/ticket-tags/${cardId}`);logger.dashboard.debug(\"âœ… Tag eliminado del origen\");}}catch(deleteErr){var _deleteErr$response2;// Si el tag no existe, no es un error\nlogger.dashboard.debug(\"â„¹ï¸ Tag no existÃ­a en origen:\",(_deleteErr$response2=deleteErr.response)===null||_deleteErr$response2===void 0?void 0:_deleteErr$response2.status);}}// Agregar el tag al destino\nif(targetTag){await api.put(`/ticket-tags/${cardId}/${targetTag.id}`);logger.dashboard.debug(\"âœ… Tag agregado al destino\");toast.success('Ticket movido exitosamente!');}logger.dashboard.debug(\"âœ… Ticket movido exitosamente\");// Recargar datos despuÃ©s del movimiento\nsetTimeout(()=>{fetchTags();},500);}catch(err){logger.dashboard.error(\"âŒ Error moviendo ticket:\",err);toast.error('Error al mover el ticket');}};const handleCardClick=ticket=>{history.push('/tickets/'+ticket.uuid);};return/*#__PURE__*/React.createElement(\"div\",{className:classes.root},/*#__PURE__*/React.createElement(KanbanBoard,{tickets:tickets,tags:tags,onCardMove:handleCardMove,onCardClick:handleCardClick}));};export default Kanban;","map":null,"metadata":{},"sourceType":"module"}