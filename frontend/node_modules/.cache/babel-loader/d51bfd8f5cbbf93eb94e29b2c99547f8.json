{"ast":null,"code":"import React,{useEffect,useRef,useState,useContext}from\"react\";import{useParams}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import{Grid,LinearProgress,Typography}from\"@material-ui/core\";import api from\"../../services/api\";import{has,get,isNull}from\"lodash\";import CardCounter from\"../../components/Dashboard/CardCounter\";import GroupIcon from\"@material-ui/icons/Group\";import ScheduleIcon from\"@material-ui/icons/Schedule\";import EventAvailableIcon from\"@material-ui/icons/EventAvailable\";import DoneIcon from\"@material-ui/icons/Done\";import DoneAllIcon from\"@material-ui/icons/DoneAll\";import CheckCircleIcon from\"@material-ui/icons/CheckCircle\";import WhatsAppIcon from\"@material-ui/icons/WhatsApp\";import ListAltIcon from\"@material-ui/icons/ListAlt\";import{useDate}from\"../../hooks/useDate\";import{SocketContext}from\"../../context/Socket/SocketContext\";import{i18n}from\"../../translate/i18n\";const useStyles=makeStyles(theme=>({mainPaper:{flex:1,padding:theme.spacing(2),overflowY:\"scroll\",...theme.scrollbarStyles},textRight:{textAlign:\"right\"},tabPanelsContainer:{padding:theme.spacing(2)}}));const CampaignReport=()=>{const classes=useStyles();const{campaignId}=useParams();const[campaign,setCampaign]=useState({});const[validContacts,setValidContacts]=useState(0);const[delivered,setDelivered]=useState(0);const[confirmationRequested,setConfirmationRequested]=useState(0);const[confirmed,setConfirmed]=useState(0);const[percent,setPercent]=useState(0);const[loading,setLoading]=useState(false);const mounted=useRef(true);const{datetimeToClient}=useDate();const socketManager=useContext(SocketContext);useEffect(()=>{if(mounted.current){findCampaign();}return()=>{mounted.current=false;};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);useEffect(()=>{if(mounted.current&&has(campaign,\"shipping\")){if(has(campaign,\"contactList\")){const contactList=get(campaign,\"contactList\");const valids=contactList.contacts.filter(c=>c.isWhatsappValid);setValidContacts(valids.length);}if(has(campaign,\"shipping\")){const contacts=get(campaign,\"shipping\");const delivered=contacts.filter(c=>!isNull(c.deliveredAt));const confirmationRequested=contacts.filter(c=>!isNull(c.confirmationRequestedAt));const confirmed=contacts.filter(c=>!isNull(c.deliveredAt)&&!isNull(c.confirmationRequestedAt));setDelivered(delivered.length);setConfirmationRequested(confirmationRequested.length);setConfirmed(confirmed.length);setDelivered(delivered.length);}}},[campaign]);useEffect(()=>{setPercent(delivered/validContacts*100);},[delivered,validContacts]);useEffect(()=>{const companyId=localStorage.getItem(\"companyId\");const socket=socketManager.getSocket(companyId);socket.on(`company-${companyId}-campaign`,data=>{if(data.record.id===+campaignId){setCampaign(data.record);if(data.record.status===\"FINALIZADA\"){setTimeout(()=>{findCampaign();},5000);}}});return()=>{socket.disconnect();};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[campaignId,socketManager]);const findCampaign=async()=>{setLoading(true);const{data}=await api.get(`/campaigns/${campaignId}`);setCampaign(data);setLoading(false);};const formatStatus=val=>{switch(val){case\"INATIVA\":return i18n.t(\"campaigns.report.statusValues.inactive\");case\"PROGRAMADA\":return i18n.t(\"campaigns.report.statusValues.scheduled\");case\"EM_ANDAMENTO\":return i18n.t(\"campaigns.report.statusValues.inProgress\");case\"CANCELADA\":return i18n.t(\"campaigns.report.statusValues.cancelled\");case\"FINALIZADA\":return i18n.t(\"campaigns.report.statusValues.finished\");default:return val;}};return/*#__PURE__*/React.createElement(MainContainer,null,/*#__PURE__*/React.createElement(MainHeader,null,/*#__PURE__*/React.createElement(Grid,{style:{width:\"99.6%\"},container:true},/*#__PURE__*/React.createElement(Grid,{xs:12,item:true},/*#__PURE__*/React.createElement(Title,null,i18n.t(\"campaigns.report.title\"),\" \",campaign.name||\"Campa√±a\")))),/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaper,variant:\"outlined\"},/*#__PURE__*/React.createElement(Typography,{variant:\"h6\",component:\"h2\"},i18n.t(\"campaigns.report.status\"),\": \",formatStatus(campaign.status),\" \",delivered,\" de \",validContacts),/*#__PURE__*/React.createElement(Grid,{spacing:2,container:true},/*#__PURE__*/React.createElement(Grid,{xs:12,item:true},/*#__PURE__*/React.createElement(LinearProgress,{variant:\"determinate\",style:{height:15,borderRadius:3,margin:\"20px 0\"},value:percent})),/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(GroupIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.validContacts\"),value:validContacts,loading:loading})),campaign.confirmation&&/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(DoneIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.confirmationRequested\"),value:confirmationRequested,loading:loading})),/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(DoneAllIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.confirmations\"),value:confirmed,loading:loading}))),/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(CheckCircleIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.delivered\"),value:delivered,loading:loading})),campaign.whatsappId&&/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(WhatsAppIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.connection\"),value:campaign.whatsapp.name,loading:loading})),campaign.contactListId&&/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(ListAltIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.contactList\"),value:campaign.contactList.name,loading:loading})),/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(ScheduleIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.scheduling\"),value:datetimeToClient(campaign.scheduledAt),loading:loading})),/*#__PURE__*/React.createElement(Grid,{xs:12,md:4,item:true},/*#__PURE__*/React.createElement(CardCounter,{icon:/*#__PURE__*/React.createElement(EventAvailableIcon,{fontSize:\"inherit\"}),title:i18n.t(\"campaigns.report.conclusion\"),value:datetimeToClient(campaign.completedAt),loading:loading})))));};export default CampaignReport;","map":null,"metadata":{},"sourceType":"module"}