{"ast":null,"code":"import React,{useState,useEffect}from\"react\";import*as Yup from\"yup\";import{Formik,Form,Field}from\"formik\";import{toast}from\"react-toastify\";import{makeStyles}from\"@material-ui/core/styles\";import{green}from\"@material-ui/core/colors\";import{Dialog,DialogContent,DialogTitle,Button,DialogActions,CircularProgress,TextField,Switch,FormControlLabel,Grid,FormControl,InputLabel,Select,MenuItem}from\"@material-ui/core\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import toastError from\"../../errors/toastError\";import QueueSelect from\"../QueueSelect\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\"},multFieldLine:{display:\"flex\",\"& > *:not(:last-child)\":{marginRight:theme.spacing(1)}},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12}}));const SessionSchema=Yup.object().shape({name:Yup.string().min(2,\"Too Short!\").max(50,\"Too Long!\").required(\"Required\")});const WhatsAppModal=_ref=>{let{open,onClose,whatsAppId,onSave}=_ref;const classes=useStyles();const initialState={name:\"\",greetingMessage:\"\",complationMessage:\"\",outOfHoursMessage:\"\",ratingMessage:\"\",isDefault:false,token:\"\",provider:\"beta\",//timeSendQueue: 0,\n//sendIdQueue: 0,\nexpiresInactiveMessage:\"\",expiresTicket:0,timeUseBotQueues:0,maxUseBotQueues:3};const[whatsApp,setWhatsApp]=useState(initialState);const[selectedQueueIds,setSelectedQueueIds]=useState([]);const[selectedQueueId,setSelectedQueueId]=useState(null);const[selectedPrompt,setSelectedPrompt]=useState(null);const[prompts,setPrompts]=useState([]);const[isLoading,setIsLoading]=useState(false);// ✅ MEJORAR CARGA DE DATOS\nuseEffect(()=>{const fetchSession=async()=>{if(!whatsAppId)return;try{var _data$queues;setIsLoading(true);const{data}=await api.get(`whatsapp/${whatsAppId}?session=0`);setWhatsApp(data);// ✅ CARGAR DEPARTAMENTOS CORRECTAMENTE PARA SELECCIÓN ÚNICA\nconst whatsQueueIds=((_data$queues=data.queues)===null||_data$queues===void 0?void 0:_data$queues.map(queue=>queue.id))||[];// ✅ PARA SELECCIÓN ÚNICA, TOMAR SOLO EL PRIMER DEPARTAMENTO\nconst singleQueueId=whatsQueueIds.length>0?whatsQueueIds[0]:null;setSelectedQueueIds(singleQueueId);setSelectedQueueId(data.transferQueueId);// ✅ CARGAR CORRECTAMENTE EL PROMPT ID\nif(data.promptId){setSelectedPrompt(data.promptId);}else{setSelectedPrompt(null);}}catch(err){console.error(\"❌ ERROR AL CARGAR DATOS:\",err);toastError(err);}finally{setIsLoading(false);}};fetchSession();},[whatsAppId]);useEffect(()=>{(async()=>{try{const{data}=await api.get(\"/prompt\");setPrompts(data.prompts);}catch(err){toastError(err);}})();},[whatsAppId]);const handleSaveWhatsApp=async values=>{try{setIsLoading(true);// ✅ VALIDACIÓN: Verificar que solo uno esté seleccionado\nconst hasDepartment=selectedQueueIds&&selectedQueueIds!==null&&selectedQueueIds!==\"\";const hasPrompt=selectedPrompt&&selectedPrompt!==null;if(hasDepartment&&hasPrompt){toast.error(\"❌ Error: No puedes seleccionar departamento y prompt simultáneamente. Selecciona solo uno.\");setIsLoading(false);return;}if(!hasDepartment&&!hasPrompt){toast.error(\"❌ Error: Debes seleccionar un departamento o un prompt.\");setIsLoading(false);return;}// ✅ PREPARAR DATOS CORRECTAMENTE\nconst whatsappData={...values,queueIds:selectedQueueIds?[selectedQueueIds]:[],// ✅ CONVERTIR A ARRAY\ntransferQueueId:selectedQueueId,promptId:selectedPrompt?selectedPrompt:null};delete whatsappData[\"queues\"];delete whatsappData[\"session\"];if(whatsAppId){await api.put(`/whatsapp/${whatsAppId}`,whatsappData);}else{await api.post(\"/whatsapp\",whatsappData);}toast.success(i18n.t(\"whatsappModal.success\"));// ✅ AGREGAR CALLBACK PARA REFRESCAR CONEXIONES\nif(onSave){onSave();}handleClose();}catch(err){console.error(\"❌ ERROR AL GUARDAR:\",err);toastError(err);}finally{setIsLoading(false);}};const handleChangeQueue=e=>{// ✅ VALIDACIÓN: Si se selecciona un departamento, limpiar prompt\nif(e&&e!==null){setSelectedPrompt(null);}// ✅ PARA SELECCIÓN ÚNICA, GUARDAR EL VALOR DIRECTO\nsetSelectedQueueIds(e);};const handleChangePrompt=e=>{// ✅ VALIDACIÓN: Si se selecciona un prompt, limpiar departamento\nif(e.target.value&&e.target.value!==null){setSelectedQueueIds(null);}setSelectedPrompt(e.target.value);};const handleClose=()=>{onClose();setWhatsApp(initialState);setSelectedQueueId(null);setSelectedQueueIds([]);setSelectedPrompt(null);setIsLoading(false);};return/*#__PURE__*/React.createElement(\"div\",{className:classes.root},/*#__PURE__*/React.createElement(Dialog,{open:open,onClose:handleClose,maxWidth:\"md\",fullWidth:true,scroll:\"paper\"},/*#__PURE__*/React.createElement(DialogTitle,null,whatsAppId?i18n.t(\"whatsappModal.title.edit\"):i18n.t(\"whatsappModal.title.add\")),/*#__PURE__*/React.createElement(Formik,{initialValues:whatsApp,enableReinitialize:true,validationSchema:SessionSchema,onSubmit:(values,actions)=>{setTimeout(()=>{handleSaveWhatsApp(values);actions.setSubmitting(false);},400);}},_ref2=>{let{values,touched,errors,isSubmitting}=_ref2;return/*#__PURE__*/React.createElement(Form,null,/*#__PURE__*/React.createElement(DialogContent,{dividers:true},/*#__PURE__*/React.createElement(\"div\",{className:classes.multFieldLine},/*#__PURE__*/React.createElement(Grid,{spacing:2,container:true},/*#__PURE__*/React.createElement(Grid,{item:true},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"whatsappModal.form.name\"),autoFocus:true,name:\"name\",error:touched.name&&Boolean(errors.name),helperText:touched.name&&errors.name,variant:\"outlined\",margin:\"dense\",className:classes.textField})),/*#__PURE__*/React.createElement(Grid,{style:{paddingTop:15},item:true},/*#__PURE__*/React.createElement(FormControlLabel,{control:/*#__PURE__*/React.createElement(Field,{as:Switch,color:\"primary\",name:\"isDefault\",checked:values.isDefault}),label:i18n.t(\"whatsappModal.form.default\")})))),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"queueModal.form.greetingMessage\"),type:\"greetingMessage\",multiline:true,rows:4,fullWidth:true,name:\"greetingMessage\",error:touched.greetingMessage&&Boolean(errors.greetingMessage),helperText:touched.greetingMessage&&errors.greetingMessage,variant:\"outlined\",margin:\"dense\"})),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"queueModal.form.complationMessage\"),type:\"complationMessage\",multiline:true,rows:4,fullWidth:true,name:\"complationMessage\",error:touched.complationMessage&&Boolean(errors.complationMessage),helperText:touched.complationMessage&&errors.complationMessage,variant:\"outlined\",margin:\"dense\"})),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"queueModal.form.outOfHoursMessage\"),type:\"outOfHoursMessage\",multiline:true,rows:4,fullWidth:true,name:\"outOfHoursMessage\",error:touched.outOfHoursMessage&&Boolean(errors.outOfHoursMessage),helperText:touched.outOfHoursMessage&&errors.outOfHoursMessage,variant:\"outlined\",margin:\"dense\"})),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"queueModal.form.ratingMessage\"),type:\"ratingMessage\",multiline:true,rows:4,fullWidth:true,name:\"ratingMessage\",error:touched.ratingMessage&&Boolean(errors.ratingMessage),helperText:touched.ratingMessage&&errors.ratingMessage,variant:\"outlined\",margin:\"dense\"})),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"queueModal.form.token\"),type:\"token\",fullWidth:true,name:\"token\",variant:\"outlined\",margin:\"dense\"})),/*#__PURE__*/React.createElement(QueueSelect,{selectedQueueIds:selectedQueueIds,onChange:selectedIds=>handleChangeQueue(selectedIds),multiple:false,title:\"Departamentos\"}),/*#__PURE__*/React.createElement(FormControl,{margin:\"dense\",variant:\"outlined\",fullWidth:true},/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"whatsappModal.form.prompt\")),/*#__PURE__*/React.createElement(Select,{labelId:\"dialog-select-prompt-label\",id:\"dialog-select-prompt\",name:\"promptId\",value:selectedPrompt||\"\",onChange:handleChangePrompt,label:i18n.t(\"whatsappModal.form.prompt\"),fullWidth:true,MenuProps:{anchorOrigin:{vertical:\"bottom\",horizontal:\"left\"},transformOrigin:{vertical:\"top\",horizontal:\"left\"},getContentAnchorEl:null}},/*#__PURE__*/React.createElement(MenuItem,{value:\"\"},\"Ninguna\"),prompts.map(prompt=>/*#__PURE__*/React.createElement(MenuItem,{key:prompt.id,value:prompt.id},prompt.name)))),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"h3\",{style:{color:'#2196f3',marginBottom:'8px'}},\"\\uD83D\\uDD04 \",i18n.t(\"whatsappModal.form.queueRedirection\"),\" - TRANSFERENCIAS AUTOM\\xC1TICAS\"),/*#__PURE__*/React.createElement(\"p\",{style:{color:'#666',fontSize:'14px',marginBottom:'16px'}},i18n.t(\"whatsappModal.form.queueRedirectionDesc\")),/*#__PURE__*/React.createElement(\"div\",{style:{background:'#f5f5f5',padding:'16px',borderRadius:'8px',marginBottom:'16px',border:'1px solid #e0e0e0'}},/*#__PURE__*/React.createElement(\"h4\",{style:{color:'#333',marginBottom:'8px'}},\"\\u23F0 Transferencia por Tiempo\"),/*#__PURE__*/React.createElement(\"p\",{style:{color:'#666',fontSize:'12px',marginBottom:'12px'}},\"Transferir tickets autom\\xE1ticamente despu\\xE9s de X minutos sin respuesta\"),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:2},/*#__PURE__*/React.createElement(Grid,{item:true,sm:6},/*#__PURE__*/React.createElement(Field,{fullWidth:true,type:\"number\",as:TextField,label:\"\\u23F1\\uFE0F Minutos para transferir\",name:\"timeToTransfer\",error:touched.timeToTransfer&&Boolean(errors.timeToTransfer),helperText:touched.timeToTransfer&&errors.timeToTransfer||\"Ej: 30 = transferir después de 30 minutos\",variant:\"outlined\",margin:\"dense\",className:classes.textField,InputLabelProps:{shrink:values.timeToTransfer?true:false}})),/*#__PURE__*/React.createElement(Grid,{item:true,sm:6},/*#__PURE__*/React.createElement(QueueSelect,{selectedQueueIds:selectedQueueId,onChange:selectedId=>{setSelectedQueueId(selectedId);},multiple:false,title:\"\\uD83C\\uDFAF Departamento destino\"})))),/*#__PURE__*/React.createElement(\"div\",{style:{background:'#e8f5e8',padding:'16px',borderRadius:'8px',marginBottom:'16px',border:'1px solid #c8e6c9'}},/*#__PURE__*/React.createElement(\"h4\",{style:{color:'#2e7d32',marginBottom:'8px'}},\"\\uD83E\\uDD16 Transferencias Inteligentes\"),/*#__PURE__*/React.createElement(\"p\",{style:{color:'#666',fontSize:'12px',marginBottom:'8px'}},/*#__PURE__*/React.createElement(\"strong\",null,\"Autom\\xE1tico:\"),\" Los tickets se transfieren entre departamentos seg\\xFAn el contenido del mensaje:\"),/*#__PURE__*/React.createElement(\"ul\",{style:{color:'#666',fontSize:'12px',marginLeft:'20px',marginBottom:'8px'}},/*#__PURE__*/React.createElement(\"li\",null,\"\\uD83D\\uDCC8 \",/*#__PURE__*/React.createElement(\"strong\",null,\"VENTAS:\"),\" Palabras como \\\"precio\\\", \\\"comprar\\\", \\\"oferta\\\", \\\"producto\\\"\"),/*#__PURE__*/React.createElement(\"li\",null,\"\\uD83D\\uDD27 \",/*#__PURE__*/React.createElement(\"strong\",null,\"SOPORTE:\"),\" Palabras como \\\"error\\\", \\\"problema\\\", \\\"ayuda\\\", \\\"t\\xE9cnico\\\"\"),/*#__PURE__*/React.createElement(\"li\",null,\"\\u23F0 \",/*#__PURE__*/React.createElement(\"strong\",null,\"Tiempo:\"),\" Sin respuesta por m\\xE1s de 30 minutos\")),/*#__PURE__*/React.createElement(\"p\",{style:{color:'#2e7d32',fontSize:'11px',fontStyle:'italic'}},\"\\u2705 Sistema activo autom\\xE1ticamente cuando hay m\\xFAltiples departamentos configurados\")),/*#__PURE__*/React.createElement(Grid,{spacing:2,container:true},/*#__PURE__*/React.createElement(Grid,{xs:12,md:12,item:true},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"whatsappModal.form.expiresTicket\"),fullWidth:true,name:\"expiresTicket\",variant:\"outlined\",margin:\"dense\",error:touched.expiresTicket&&Boolean(errors.expiresTicket),helperText:touched.expiresTicket&&errors.expiresTicket}))),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"whatsappModal.form.expiresInactiveMessage\"),multiline:true,rows:4,fullWidth:true,name:\"expiresInactiveMessage\",error:touched.expiresInactiveMessage&&Boolean(errors.expiresInactiveMessage),helperText:touched.expiresInactiveMessage&&errors.expiresInactiveMessage,variant:\"outlined\",margin:\"dense\"})))),/*#__PURE__*/React.createElement(DialogActions,null,/*#__PURE__*/React.createElement(Button,{onClick:handleClose,color:\"secondary\",disabled:isSubmitting||isLoading,variant:\"outlined\"},i18n.t(\"whatsappModal.buttons.cancel\")),/*#__PURE__*/React.createElement(Button,{type:\"submit\",color:\"primary\",disabled:isSubmitting||isLoading,variant:\"contained\",className:classes.btnWrapper},whatsAppId?i18n.t(\"whatsappModal.buttons.okEdit\"):i18n.t(\"whatsappModal.buttons.okAdd\"),(isSubmitting||isLoading)&&/*#__PURE__*/React.createElement(CircularProgress,{size:24,className:classes.buttonProgress}))));})));};export default React.memo(WhatsAppModal);","map":null,"metadata":{},"sourceType":"module"}